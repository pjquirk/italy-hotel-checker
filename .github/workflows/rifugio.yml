name: Checking Rifugio Availability

on:
  workflow_dispatch:
    inputs:
      month:
        description: 'Month to check availability (MM)'
        required: true
        default: '07' # July
      day:
        description: 'Day to check availability (DD)'
        required: true
        default: '07' # 7th
      guests:
        description: 'Number of guests'
        required: true
        default: 2
        type: number
  schedule:
    - cron: '1 * * * *' # Every hour

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        hostels: [
          { name: "Rifugio Fodara Vedla", url: "https://www.fodara.it", id: 12869 },
          { name: "Rifugio PederÃ¼", url: "https://www.pederu.it", id: 10716 },
          { name: "Rifugio Fanes", url: "https://www.fanes.it", id: 13308 },
          { name: "Rifugio Lavarella", url: "https://www.lavarella.it", id: 13004 },
        ]

    env:
      MONTH: ${{ github.event.inputs.month }}
      DAY: ${{ github.event.inputs.day }}
      GUESTS: ${{ github.event.inputs.guests }}

    steps:
      - name: Check for an open spot on July 7
        id: check_availability
        run: |
          # Continue on error
          set +e

          # Query the API for availability
          URL="https://api.widgets.bookingsuedtirol.com/v6/properties/${{ matrix.hostels.id }}/availabilities?from=2025-${{ env.MONTH }}-01&guests=%5B%5B18%${{ env.GUESTS }}C18%5D%5D&sourceId=98&to=2025-${{ env.MONTH }}-31"
          curl -s "$URL" | jq -e -r '.[] | select(.date == "2025-${{ env.MONTH }}-${{ env.DAY }}") | .departures[] | select(.rule == "departure_possible") | .departure'

          # Append an output if the command succeeds
          if [[ $? -eq 0 ]]; then
            echo "The spot is available for the specified date."
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "No spot available for the specified date."
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify if the spot is available
        uses: appricos/pushinator-action@v1
        if: success() && steps.check_availability.outputs.available == 'true'
        with:
          apiToken: ${{ secrets.PUSHINATOR_API_TOKEN }}
          channelId: ${{ secrets.PUSHINATOR_CHANNEL_ID }}
          notification: |
            A spot is available for the specified date at: ${{ matrix.hostels.name }} (id: ${{ matrix.hostels.id }}).
            Book it at ${{ matrix.hostels.url }}

